# Step 1 — Direct 6D control for right hand toward thigh_top
# Mannequin fixed
# Right arm only (ignore left)
# Uses Damped Least-Squares inverse kinematics

import numpy as np

def reset():
    # Fix the mannequin in a bent configuration
    leg.jointPositions = [0.707, -1.5]

    # Return zero joint positions (17-DoF humanoid)
    return [0.] * 17


def control(x, dt):
    # Keep mannequin fixed every frame 
    leg.jointPositions = [0.707, -1.5]

    #  Kinematics
    J = Jkin(x)         
    f = fkin(x)   

    # Desired right-hand pose: thigh_top slot 
    mu = np.ndarray((14,))
    mu[:7] = getTransforms('thigh_top')   # right-hand target
    mu[7:] = f[7:]                        # left hand = hold still

    # 6-D pose error for right hand (position + orientation)
    eR = logmap(mu[:7], f[:7])            # 6-D error in SE(3) tangent space

    # Extract right-hand Jacobian block (first 6 rows)
    JR = J[:6, :]                         # 6 × 17

    # Damped Least-Squares inverse (stable IK) 
    lam = 0.1                             # damping factor (0.05–0.2 works i guess)
    JJt = JR @ JR.T
    J_dls = JR.T @ np.linalg.inv(JJt + lam**2 * np.eye(6))


    dq = J_dls @ eR

    # Velocity scaling
    alpha = 0.8
    qdot = alpha * (dq / max(dt, 1e-6))
    qdot = np.clip(qdot, -2.0, 2.0)

    return qdot
